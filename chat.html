<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí¨ –ß–∞—Ç –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            background: var(--tg-theme-secondary-bg-color, #f1f1f1);
            padding: 15px;
            border-bottom: 1px solid var(--tg-theme-hint-color, #ccc);
            text-align: center;
        }
        
        .status {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999);
            margin-top: 5px;
        }
        
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 75%;
            word-wrap: break-word;
            position: relative;
        }
        
        .message.user {
            background: var(--tg-theme-button-color, #007AFF);
            color: var(--tg-theme-button-text-color, #ffffff);
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .message.admin {
            background: var(--tg-theme-secondary-bg-color, #f1f1f1);
            color: var(--tg-theme-text-color, #000000);
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
        
        .message-time {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 5px;
        }
        
        .input-container {
            display: flex;
            padding: 15px;
            border-top: 1px solid var(--tg-theme-hint-color, #ccc);
            background: var(--tg-theme-bg-color, #ffffff);
            gap: 10px;
        }
        
        .message-input {
            flex: 1;
            border: 1px solid var(--tg-theme-hint-color, #ccc);
            border-radius: 25px;
            padding: 12px 20px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            outline: none;
        }
        
        .send-button {
            background: var(--tg-theme-button-color, #007AFF);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .typing-indicator {
            font-style: italic;
            color: var(--tg-theme-hint-color, #999);
            padding: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="chat-header">
        <h3>üí¨ –ß–∞—Ç –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é</h3>
        <div class="status" id="status">–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...</div>
    </div>
    
    <div class="chat-container" id="chatContainer">
        <div class="message admin">
            –í—ñ—Ç–∞—î–º–æ! –Ø–∫ –º–æ–∂–µ–º–æ –¥–æ–ø–æ–º–æ–≥—Ç–∏?
            <div class="message-time">–ó–∞—Ä–∞–∑</div>
        </div>
    </div>
    
    <div class="typing-indicator" id="typingIndicator" style="display: none;">
        –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä –¥—Ä—É–∫—É—î...
    </div>
    
    <div class="input-container">
        <input type="text" class="message-input" id="messageInput" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." maxlength="1000">
        <button class="send-button" id="sendButton" onclick="sendMessage()">üì§</button>
    </div>
    
    <script>
        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Telegram WebApp
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();
        
        // –û—Ç—Ä–∏–º—É—î–º–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('user_id');
        const chatId = urlParams.get('chat_id');
        
        let ws = null;
        let isConnected = false;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        
        console.log('–ü–∞—Ä–∞–º–µ—Ç—Ä–∏:', { userId, chatId });
        
        if (!userId || !chatId) {
            document.getElementById('status').textContent = '–ü–æ–º–∏–ª–∫–∞: –≤—ñ–¥—Å—É—Ç–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏';
        } else {
            connectWebSocket();
        }
        
        function connectWebSocket() {
            try {
                // –ì–û–õ–û–í–ù–ê –ó–ú–Ü–ù–ê: –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ—Å—è —á–µ—Ä–µ–∑ WebSocket –¥–æ api_server.py
                ws = new WebSocket(`ws://localhost:8001/ws/${chatId}`);
                
                ws.onopen = function() {
                    console.log('WebSocket –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ');
                    isConnected = true;
                    reconnectAttempts = 0;
                    document.getElementById('status').textContent = '–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ';
                    
                    // –ó–∞–ø–∏—Ç—É—î–º–æ —ñ—Å—Ç–æ—Ä—ñ—é —á–∞—Ç—É
                    ws.send(JSON.stringify({
                        type: 'get_history',
                        chat_id: chatId
                    }));
                };
                
                ws.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    console.log('–û—Ç—Ä–∏–º–∞–Ω–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:', data);
                    
                    switch(data.type) {
                        case 'history':
                            loadChatHistory(data.messages);
                            break;
                        case 'new_message':
                            if (data.sender_type === 'admin') {
                                addMessageToChat('admin', data.message, data.timestamp);
                            }
                            break;
                        case 'typing':
                            showTypingIndicator(data.is_typing);
                            break;
                    }
                };
                
                ws.onclose = function() {
                    console.log('WebSocket –≤—ñ–¥–∫–ª—é—á–µ–Ω–æ');
                    isConnected = false;
                    document.getElementById('status').textContent = '–í—ñ–¥–∫–ª—é—á–µ–Ω–æ';
                    
                    // –°–ø—Ä–æ–±—É—î–º–æ –ø–µ—Ä–µ–ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è
                    if (reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        console.log(`–°–ø—Ä–æ–±–∞ –ø–µ—Ä–µ–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è ${reconnectAttempts}/${maxReconnectAttempts}`);
                        setTimeout(connectWebSocket, 2000 * reconnectAttempts);
                    }
                };
                
                ws.onerror = function(error) {
                    console.error('–ü–æ–º–∏–ª–∫–∞ WebSocket:', error);
                    document.getElementById('status').textContent = '–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è';
                };
                
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è WebSocket:', error);
                document.getElementById('status').textContent = '–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è';
            }
        }
        
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message || !isConnected) {
                console.log('–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø–æ—Ä–æ–∂–Ω—î –∞–±–æ –Ω–µ–º–∞—î –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è');
                return;
            }
            
            // –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑ Telegram
            const tgUser = window.Telegram.WebApp.initDataUnsafe?.user;
            
            // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ —á–µ—Ä–µ–∑ WebSocket
            const messageData = {
                type: 'send_message',
                message: message,
                user_id: parseInt(userId),
                chat_id: parseInt(chatId),
                username: tgUser?.username || '–Ω–µ–≤—ñ–¥–æ–º–æ',
                first_name: tgUser?.first_name || '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'
            };
            
            console.log('–í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ:', messageData);
            ws.send(JSON.stringify(messageData));
            
            // –î–æ–¥–∞—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ —á–∞—Ç –ª–æ–∫–∞–ª—å–Ω–æ
            addMessageToChat('user', message);
            messageInput.value = '';
        }
        
        function loadChatHistory(messages) {
            const chatContainer = document.getElementById('chatContainer');
            // –û—á–∏—â—É—î–º–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤—ñ–¥ –ø–æ—á–∞—Ç–∫–æ–≤–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
            chatContainer.innerHTML = '';
            
            messages.forEach(msg => {
                addMessageToChat(msg.sender_type, msg.message_text, msg.sent_at, false);
            });
            
            // –Ø–∫—â–æ —ñ—Å—Ç–æ—Ä—ñ—ó –Ω–µ–º–∞—î, –ø–æ–∫–∞–∑—É—î–º–æ –ø—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è
            if (messages.length === 0) {
                addMessageToChat('admin', '–í—ñ—Ç–∞—î–º–æ! –Ø–∫ –º–æ–∂–µ–º–æ –¥–æ–ø–æ–º–æ–≥—Ç–∏?', new Date().toISOString(), false);
            }
        }
        
        function addMessageToChat(sender, message, timestamp = null, scroll = true) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const time = timestamp ? new Date(timestamp) : new Date();
            const timeStr = time.toLocaleTimeString('uk-UA', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            messageDiv.innerHTML = `
                ${message}
                <div class="message-time">${timeStr}</div>
            `;
            
            chatContainer.appendChild(messageDiv);
            
            if (scroll) {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }
        
        function showTypingIndicator(isTyping) {
            const indicator = document.getElementById('typingIndicator');
            indicator.style.display = isTyping ? 'block' : 'none';
        }
        
        // –û–±—Ä–æ–±–∫–∞ Enter –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∫–æ–ª—å–æ—Ä–æ–≤–æ—ó —Å—Ö–µ–º–∏ Telegram
        document.documentElement.style.setProperty('--tg-theme-bg-color', window.Telegram.WebApp.themeParams.bg_color || '#ffffff');
        document.documentElement.style.setProperty('--tg-theme-text-color', window.Telegram.WebApp.themeParams.text_color || '#000000');
        document.documentElement.style.setProperty('--tg-theme-button-color', window.Telegram.WebApp.themeParams.button_color || '#007AFF');
        document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', window.Telegram.WebApp.themeParams.secondary_bg_color || '#f1f1f1');
        document.documentElement.style.setProperty('--tg-theme-hint-color', window.Telegram.WebApp.themeParams.hint_color || '#999999');
    </script>
</body>
</html>
