<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ß–∞—Ç –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, white);
            padding: 15px;
            text-align: center;
            font-weight: bold;
        }
        
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
        }
        
        .message {
            margin: 10px 0;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 85%;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.user {
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, white);
            margin-left: auto;
            text-align: right;
        }
        
        .message.admin {
            background: var(--tg-theme-secondary-bg-color, #e5e5ea);
            color: var(--tg-theme-text-color, #000);
            border: 1px solid var(--tg-theme-hint-color, #ddd);
        }
        
        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 5px;
        }
        
        .message-status {
            font-size: 12px;
            margin-top: 5px;
            text-align: right;
        }
        
        .status-read { color: #4fc3f7; }
        .status-delivered { color: #666; }
        .status-sending { color: #999; }
        
        .input-container {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: var(--tg-theme-bg-color, white);
            border-top: 1px solid var(--tg-theme-hint-color, #ccc);
        }
        
        .message-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--tg-theme-hint-color, #ccc);
            border-radius: 25px;
            outline: none;
            background: var(--tg-theme-bg-color, white);
            color: var(--tg-theme-text-color, black);
            resize: none;
            min-height: 20px;
            max-height: 100px;
        }
        
        .send-button {
            padding: 12px 20px;
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, white);
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .send-button:hover {
            background: var(--tg-theme-button-color, #006699);
        }
        
        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .typing-indicator {
            padding: 10px 15px;
            font-style: italic;
            color: var(--tg-theme-hint-color, #999);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .typing-indicator.show {
            opacity: 1;
        }
        
        .close-chat-btn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 15px;
            margin: 10px 15px;
            cursor: pointer;
        }
        
        .connection-status {
            text-align: center;
            padding: 5px;
            font-size: 12px;
            background: #fff3cd;
            color: #856404;
            display: none;
        }
    </style>
</head>
<body>
    <div class="chat-header">
        üí¨ –ß–∞—Ç –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é
    </div>
    
    <div class="connection-status" id="connectionStatus">
        –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...
    </div>
    
    <div class="chat-container" id="chatContainer">
        <div class="message admin">
            –í—ñ—Ç–∞—î–º–æ! –Ø–∫ –º–æ–∂–µ–º–æ –¥–æ–ø–æ–º–æ–≥—Ç–∏?
            <div class="message-time">–ó–∞—Ä–∞–∑</div>
        </div>
    </div>
    
    <div class="typing-indicator" id="typingIndicator">
        –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä –¥—Ä—É–∫—É—î...
    </div>
    
    <div class="input-container">
        <textarea id="messageInput" class="message-input" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." rows="1"></textarea>
        <button id="sendButton" class="send-button">‚û§</button>
    </div>
    
    <button class="close-chat-btn" onclick="closeChat()">–ó–∞–∫—Ä–∏—Ç–∏ —á–∞—Ç</button>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        
        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const typingIndicator = document.getElementById('typingIndicator');
        const connectionStatus = document.getElementById('connectionStatus');
        
        // –û—Ç—Ä–∏–º—É—î–º–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('user_id');
        const chatId = urlParams.get('chat_id');
        
        let ws = null;
        let reconnectInterval = null;
        
        // –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ WebSocket
        function connectWebSocket() {
            ws = new WebSocket(`ws://localhost:8001/ws/${chatId}`);
            
            ws.onopen = function() {
                console.log('WebSocket –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ');
                connectionStatus.style.display = 'none';
                clearInterval(reconnectInterval);
                loadChatHistory();
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            ws.onclose = function() {
                console.log('WebSocket –≤—ñ–¥–∫–ª—é—á–µ–Ω–æ');
                connectionStatus.textContent = '–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –≤—Ç—Ä–∞—á–µ–Ω–æ. –°–ø—Ä–æ–±–∞ –ø–µ—Ä–µ–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...';
                connectionStatus.style.display = 'block';
                attemptReconnect();
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket –ø–æ–º–∏–ª–∫–∞:', error);
            };
        }
        
        function attemptReconnect() {
            reconnectInterval = setInterval(() => {
                console.log('–°–ø—Ä–æ–±–∞ –ø–µ—Ä–µ–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...');
                connectWebSocket();
            }, 3000);
        }
        
        function handleWebSocketMessage(data) {
            switch(data.type) {
                case 'new_message':
                    addMessage(data.message, data.sender_type === 'user', data.timestamp);
                    break;
                case 'message_read':
                    updateMessageStatus(data.message_id, 'read');
                    break;
                case 'typing':
                    showTypingIndicator(data.is_typing);
                    break;
                case 'history':
                    loadHistoryMessages(data.messages);
                    break;
            }
        }
        
        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —ñ—Å—Ç–æ—Ä—ñ—é —á–∞—Ç—É
        function loadChatHistory() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'get_history',
                    chat_id: chatId
                }));
            }
        }
        
        function loadHistoryMessages(messages) {
            chatContainer.innerHTML = '';
            messages.forEach(msg => {
                addMessage(msg.message_text, msg.sender_type === 'user', msg.sent_at, msg.is_read);
            });
        }
        
        // –î–æ–¥–∞—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–æ —á–∞—Ç—É
        function addMessage(text, isUser = false, timestamp = null, isRead = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'admin'}`;
            
            const timeStr = timestamp ? formatTime(timestamp) : formatTime(new Date().toISOString());
            let statusIcon = '';
            
            if (isUser) {
                statusIcon = isRead ? '<span class="status-read">‚úì‚úì</span>' : '<span class="status-delivered">‚úì</span>';
            }
            
            messageDiv.innerHTML = `
                ${text}
                <div class="message-time">${timeStr} ${statusIcon}</div>
            `;
            
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
        }
        
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit' });
        }
        
        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        function updateMessageStatus(messageId, status) {
            // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç—É—Å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
            const messages = chatContainer.querySelectorAll('.message.user');
            messages.forEach(msg => {
                const statusSpan = msg.querySelector('.status-delivered, .status-read');
                if (statusSpan && status === 'read') {
                    statusSpan.className = 'status-read';
                    statusSpan.innerHTML = '‚úì‚úì';
                }
            });
        }
        
        function showTypingIndicator(isTyping) {
            if (isTyping) {
                typingIndicator.classList.add('show');
            } else {
                typingIndicator.classList.remove('show');
            }
        }
        
        // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        function sendMessage() {
            const message = messageInput.value.trim();
            if (!message || !ws || ws.readyState !== WebSocket.OPEN) return;
            
            // –î–æ–¥–∞—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            addMessage(message, true);
            messageInput.value = '';
            adjustTextareaHeight();
            
            // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ —á–µ—Ä–µ–∑ WebSocket
            ws.send(JSON.stringify({
                type: 'send_message',
                chat_id: chatId,
                user_id: userId,
                message: message,
                sender_type: 'user'
            }));
        }
        
        function closeChat() {
            if (ws) {
                ws.send(JSON.stringify({
                    type: 'close_chat',
                    chat_id: chatId
                }));
            }
            tg.close();
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–º—ñ–Ω—é—î–º–æ –≤–∏—Å–æ—Ç—É –ø–æ–ª—è –≤–≤–µ–¥–µ–Ω–Ω—è
        function adjustTextareaHeight() {
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 100) + 'px';
        }
        
        // –ü–æ–¥—ñ—ó
        sendButton.addEventListener('click', sendMessage);
        
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        messageInput.addEventListener('input', () => {
            adjustTextareaHeight();
            
            // –°–ø–æ–≤—ñ—â–∞—î–º–æ –ø—Ä–æ –Ω–∞–±—ñ—Ä —Ç–µ–∫—Å—Ç—É
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'typing',
                    chat_id: chatId,
                    is_typing: messageInput.value.length > 0
                }));
            }
        });
        
        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
        connectWebSocket();
    </script>
</body>
</html>
