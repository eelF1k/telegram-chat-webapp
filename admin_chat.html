<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Адмін-панель чату</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        height: 100vh;
        display: flex;
        background: #f8f9fa;
        color: #212529;
    }
    
    .sidebar {
        width: 350px;
        background: #ffffff;
        border-right: 1px solid #e9ecef;
        display: flex;
        flex-direction: column;
        box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    }
    
    .sidebar-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        text-align: center;
    }
    
    .filters {
        padding: 15px;
        border-bottom: 1px solid #f1f3f4;
        background: #fafbfc;
    }
    
    .filter-btn {
        background: #ffffff;
        border: 1px solid #dee2e6;
        padding: 8px 12px;
        margin: 2px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 12px;
        color: #495057;
        transition: all 0.2s ease;
    }
    
    .filter-btn:hover {
        background: #e9ecef;
        border-color: #adb5bd;
    }
    
    .filter-btn.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #667eea;
    }
    
    .search-box, #userFilter {
        width: 100%;
        padding: 10px 16px;
        border: 1px solid #dee2e6;
        border-radius: 25px;
        margin-top: 10px;
        background: #ffffff;
        color: #495057;
        font-size: 14px;
    }
    
    .search-box:focus, #userFilter:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .chat-list {
        flex: 1;
        overflow-y: auto;
        background: #ffffff;
    }
    
    .chat-item {
        padding: 16px;
        border-bottom: 1px solid #f8f9fa;
        cursor: pointer;
        transition: all 0.2s ease;
        margin: 2px 8px;
        border-radius: 12px;
    }
    
    .chat-item:hover {
        background: #f8f9fa;
        transform: translateX(4px);
    }
    
    .chat-item.active {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        border-left: 4px solid #667eea;
        margin-left: 8px;
    }
    
    .chat-item.unread {
        background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 152, 0, 0.1) 100%);
        font-weight: 600;
    }
    
    .chat-item.unread::before {
        content: '●';
        color: #ff9800;
        font-size: 16px;
        margin-right: 8px;
    }
    
    .chat-name {
        font-weight: 600;
        margin-bottom: 6px;
        color: #212529;
        font-size: 15px;
    }
    
    .chat-preview {
        font-size: 13px;
        color: #6c757d;
        margin-bottom: 6px;
        line-height: 1.4;
    }
    
    .chat-time {
        font-size: 11px;
        color: #adb5bd;
    }
    
    .main-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #ffffff;
    }
    
    .chat-header {
        background: #ffffff;
        padding: 20px;
        border-bottom: 1px solid #f1f3f4;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .user-info h3 {
        margin-bottom: 6px;
        color: #212529;
        font-size: 18px;
    }
    
    .user-status {
        font-size: 13px;
        color: #6c757d;
    }
    
    .quick-actions {
        display: flex;
        gap: 12px;
    }
    
    .action-btn {
        padding: 10px 18px;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .btn-block {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        color: white;
    }
    
    .btn-block:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(238, 90, 36, 0.3);
    }
    
    .btn-close {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        color: white;
    }
    
    .btn-close:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
    }
    
    .chat-messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: linear-gradient(145deg, #f8f9fa 0%, #ffffff 100%);
    }
    
    .message {
        margin: 12px 0;
        padding: 14px 18px;
        border-radius: 18px;
        max-width: 70%;
        word-wrap: break-word;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .message.user {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        margin-left: auto;
        text-align: right;
    }
    
    .message.admin {
        background: #ffffff;
        border: 1px solid #e9ecef;
        color: #212529;
    }
    
    .message-time {
        font-size: 11px;
        opacity: 0.7;
        margin-top: 6px;
        color: inherit;
    }
    
    .reply-area {
        background: #ffffff;
        padding: 20px;
        border-top: 1px solid #f1f3f4;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
    }
    
    .templates {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
        flex-wrap: wrap;
    }
    
    .template-btn {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 1px solid #dee2e6;
        padding: 8px 14px;
        border-radius: 18px;
        cursor: pointer;
        font-size: 12px;
        color: #495057;
        transition: all 0.2s ease;
    }
    
    .template-btn:hover {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    .reply-input {
        display: flex;
        gap: 12px;
    }
    
    .reply-textarea {
        flex: 1;
        padding: 14px 18px;
        border: 1px solid #dee2e6;
        border-radius: 20px;
        resize: none;
        min-height: 50px;
        background: #ffffff;
        color: #212529;
        font-size: 14px;
    }
    
    .reply-textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .send-reply-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 14px 24px;
        border-radius: 20px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .send-reply-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    .no-chat-selected {
        display: flex;
        align-items: center;
        justify-content: center;
        flex: 1;
        color: #6c757d;
        font-size: 18px;
        background: linear-gradient(145deg, #f8f9fa 0%, #ffffff 100%);
    }
    
    .typing-indicator {
        padding: 12px 20px;
        font-style: italic;
        color: #6c757d;
        background: #f8f9fa;
        margin: 8px 16px;
        border-radius: 20px;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .typing-indicator.show {
        opacity: 1;
    }
    
    .message-filter-btn {
        background: #ffffff;
        border: 1px solid #dee2e6;
        padding: 8px 16px;
        margin: 0 4px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s ease;
        color: #495057;
    }
    
    .message-filter-btn:hover {
        background: #f8f9fa;
        border-color: #adb5bd;
    }
    
    .message-filter-btn.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #667eea;
    }
</style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Чати підтримки</h2>
            <div style="font-size: 12px; margin-top: 5px;" id="chatCount">0 активних чатів</div>
        </div>
        
        <div class="filters">
            <div>
                <button class="filter-btn active" data-filter="all">Всі</button>
                <button class="filter-btn" data-filter="new">Нові</button>
                <button class="filter-btn" data-filter="waiting">Очікують</button>
                <button class="filter-btn" data-filter="answered">Відповідано</button>
                <button class="filter-btn" data-filter="closed">Закриті</button>
            </div>
            
            <div style="margin-top: 10px;">
                <label for="userFilter">Фільтр по користувачу:</label>
                <select id="userFilter">
                    <option value="">Всі користувачі</option>
                </select>
            </div>
            
            <input type="text" class="search-box" placeholder="Пошук користувачів..." id="searchBox">
        </div>
        
        <div class="chat-list" id="chatList">
            <!-- Чати будуть додані динамічно -->
        </div>
    </div>
    
    <div class="main-area">
        <div id="noChatSelected" class="no-chat-selected">
            Оберіть чат зі списку
        </div>
        
        <div id="chatArea" style="display: none; flex-direction: column; height: 100%;">
            <div class="chat-header">
                <div class="user-info">
                    <h3 id="currentUserName">Користувач</h3>
                    <div class="user-status" id="currentUserStatus">Остання активність: невідомо</div>
                </div>
                
                <div class="quick-actions">
                    <button class="action-btn btn-block" onclick="blockUser()">Заблокувати</button>
                    <button class="action-btn btn-close" onclick="closeCurrentChat()">Закрити чат</button>
                </div>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <!-- Повідомлення будуть додані динамічно -->
            </div>
            
            <div class="typing-indicator" id="typingIndicator">
                Користувач друкує...
            </div>
            
            <div class="reply-area">
                <div class="templates">
                    <button class="template-btn" onclick="insertTemplate('Дякуємо за звернення! Ми вже працюємо над вашим питанням.')">Стандартна відповідь</button>
                    <button class="template-btn" onclick="insertTemplate('Будь ласка, надайте більше деталей.')">Запит деталей</button>
                    <button class="template-btn" onclick="insertTemplate('Вашу проблему вирішено. Дякуємо за звернення!')">Проблему вирішено</button>
                    <button class="template-btn" onclick="insertTemplate('Передаю ваше питання спеціалісту.')">Передача спеціалісту</button>
                </div>
                
                <div class="reply-input">
                    <textarea id="replyText" class="reply-textarea" placeholder="Введіть відповідь..."></textarea>
                    <button class="send-reply-btn" onclick="sendReply()">Відправити</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('Початок завантаження скрипта адмін-панелі...');
        console.log('window.Telegram:', window.Telegram);
        console.log('Є тільки в Telegram?', window.parent !== window);
        
        // Чекаємо завантаження Telegram API
        function waitForTelegram(callback, attempts = 0) {
            if (attempts > 10) {
                console.error('Telegram WebApp API не завантажився після 10 спроб');
                document.body.innerHTML = '<div style="text-align: center; padding: 50px; font-family: Arial;">❌ Помилка завантаження Telegram WebApp API<br><br>Спробуйте перезапустити бота або оновити Telegram<br><br><button onclick="location.reload()" style="padding: 10px 20px; margin-top: 10px;">Оновити сторінку</button></div>';
                return;
            }
            
            if (window.Telegram && window.Telegram.WebApp) {
                console.log('Telegram WebApp API знайдено!');
                callback();
            } else {
                console.log(`Спроба ${attempts + 1}: Очікуємо Telegram API...`);
                setTimeout(() => waitForTelegram(callback, attempts + 1), 500);
            }
        }
        
        // Ініціалізуємо після завантаження
        waitForTelegram(() => {
            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
            console.log('Telegram WebApp успішно ініціалізовано!');
            
            initAdminPanel();
        });
        
        function initAdminPanel() {
            console.log('Ініціалізація адмін-панелі...');
            
            // Глобальні змінні
            let currentChatId = null;
            let allChats = [];
            let currentFilter = 'all';
            let selectedUserId = null;
            let updateInterval = null;
            
            // Шаблони відповідей
            const responseTemplates = [
                'Дякуємо за звернення! Ми вже працюємо над вашим питанням.',
                'Будь ласка, надайте більше деталей.',
                'Вашу проблему вирішено. Дякуємо за звернення!',
                'Передаю ваше питання спеціалісту.',
                'На жаль, ця функція наразі недоступна. Слідкуйте за оновленнями.',
                'Ваш запит опрацьовується. Очікуйте відповіді найближчим часом.',
                'Спробуйте перезапустити бота командою /start',
                'З технічних причин сервіс тимчасово недоступний.'
            ];
            
            // DOM елементи
            const chatList = document.getElementById('chatList');
            const chatContainer = document.getElementById('chatMessages');
            const replyTextArea = document.getElementById('replyText');
            const sendReplyBtn = document.querySelector('.send-reply-btn');
            const userFilter = document.getElementById('userFilter');
            const searchBox = document.getElementById('searchBox');
            const chatCount = document.getElementById('chatCount');
            const typingIndicator = document.getElementById('typingIndicator');
            
            // Завантаження всіх чатів з локального збереження (для тестування)
            async function loadAllChats() {
                try {
                    console.log('Завантаження списку чатів...');
                    
                    // Моковані дані для тестування
                    const mockChats = [
                        {
                            chat_id: 1,
                            user_id: 6778182293,
                            first_name: 'Тестовий',
                            username: 'testuser',
                            status: 'new',
                            message_count: 3,
                            last_message: 'Привіт! Можете допомогти?',
                            updated_at: new Date().toISOString(),
                            unread_count: 2
                        },
                        {
                            chat_id: 2,
                            user_id: 123456789,
                            first_name: 'Інший',
                            username: 'anotheruser',
                            status: 'waiting',
                            message_count: 1,
                            last_message: 'Чекаю відповіді',
                            updated_at: new Date(Date.now() - 3600000).toISOString(),
                            unread_count: 1
                        }
                    ];
                    
                    allChats = mockChats;
                    updateUserFilter();
                    renderChatList();
                    
                } catch (error) {
                    console.error('Помилка завантаження чатів:', error);
                }
            }
            
            // Оновлення фільтра користувачів
            function updateUserFilter() {
                if (!userFilter) return;
                
                const uniqueUsers = new Map();
                
                allChats.forEach(chat => {
                    if (chat.user_id && !uniqueUsers.has(chat.user_id)) {
                        uniqueUsers.set(chat.user_id, {
                            id: chat.user_id,
                            name: chat.first_name || 'Користувач',
                            username: chat.username || 'невідомо'
                        });
                    }
                });
                
                userFilter.innerHTML = '<option value="">Всі користувачі</option>';
                
                uniqueUsers.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.name} (@${user.username})`;
                    userFilter.appendChild(option);
                });
            }
            
            // Фільтрація та відображення списку чатів
            function renderChatList() {
                if (!chatList) return;
                
                const searchTerm = searchBox ? searchBox.value.toLowerCase() : '';
                
                // Фільтруємо чати
                let filteredChats = allChats.filter(chat => {
                    const matchesStatus = currentFilter === 'all' || chat.status === currentFilter;
                    const matchesUser = !selectedUserId || chat.user_id == selectedUserId;
                    const matchesSearch = !searchTerm || 
                        (chat.first_name && chat.first_name.toLowerCase().includes(searchTerm)) ||
                        (chat.username && chat.username.toLowerCase().includes(searchTerm));
                    
                    return matchesStatus && matchesUser && matchesSearch;
                });
                
                filteredChats.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
                
                chatList.innerHTML = '';
                
                if (chatCount) {
                    chatCount.textContent = `${filteredChats.length} чатів`;
                }
                
                filteredChats.forEach(chat => {
                    const chatItem = document.createElement('div');
                    chatItem.className = `chat-item ${chat.status}`;
                    
                    if (chat.unread_count > 0) {
                        chatItem.classList.add('unread');
                    }
                    
                    if (currentChatId === chat.chat_id) {
                        chatItem.classList.add('active');
                    }
                    
                    chatItem.onclick = () => selectChat(chat.chat_id);
                    
                    const lastMessage = chat.last_message || 'Повідомлень немає';
                    const timeStr = formatTime(chat.updated_at);
                    
                    chatItem.innerHTML = `
                        <div class="chat-name">${chat.first_name || 'Користувач'} (@${chat.username || 'невідомо'})</div>
                        <div class="chat-preview">${lastMessage}</div>
                        <div class="chat-time">${timeStr}</div>
                    `;
                    
                    chatList.appendChild(chatItem);
                });
            }
            
            // Вибір чату
            function selectChat(chatId) {
                currentChatId = chatId;
                
                document.querySelectorAll('.chat-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                event.target.closest('.chat-item').classList.add('active');
                
                const noChatSelected = document.getElementById('noChatSelected');
                const chatArea = document.getElementById('chatArea');
                
                if (noChatSelected) noChatSelected.style.display = 'none';
                if (chatArea) chatArea.style.display = 'flex';
                
                loadChatHistory(chatId);
                
                const chat = allChats.find(c => c.chat_id === chatId);
                if (chat) {
                    const userNameElement = document.getElementById('currentUserName');
                    const userStatusElement = document.getElementById('currentUserStatus');
                    
                    if (userNameElement) {
                        userNameElement.textContent = `${chat.first_name || 'Користувач'} (@${chat.username || 'невідомо'})`;
                    }
                    
                    if (userStatusElement) {
                        userStatusElement.textContent = `Остання активність: ${formatTime(chat.updated_at)}`;
                    }
                }
            }
            
            // Завантаження історії чату
            async function loadChatHistory(chatId) {
                try {
                    console.log(`Завантаження історії чату ${chatId}`);
                    
                    const mockMessages = [
                        {
                            message_text: 'Привіт! Можете допомогти з проблемою?',
                            sender_type: 'user',
                            sent_at: new Date(Date.now() - 7200000).toISOString()
                        },
                        {
                            message_text: 'Звичайно! Опишіть детальніше вашу проблему.',
                            sender_type: 'admin',
                            sent_at: new Date(Date.now() - 3600000).toISOString()
                        },
                        {
                            message_text: 'У мене не працює функція пошуку курсів',
                            sender_type: 'user',
                            sent_at: new Date(Date.now() - 1800000).toISOString()
                        }
                    ];
                    
                    displayChatHistory(mockMessages);
                    
                } catch (error) {
                    console.error('Помилка завантаження історії чату:', error);
                }
            }
            
            // Відображення історії чату
            function displayChatHistory(messages) {
                if (!chatContainer) return;
                
                if (!document.getElementById('messageFilters')) {
                    addMessageFilters(messages);
                }
                
                renderMessages(messages);
            }
            
            // Додавання кнопок фільтрації повідомлень
            function addMessageFilters(messages) {
                const filtersDiv = document.createElement('div');
                filtersDiv.id = 'messageFilters';
                filtersDiv.style.cssText = 'margin-bottom: 15px; text-align: center;';
                filtersDiv.innerHTML = `
                    <button class="message-filter-btn active" data-type="all">Всі повідомлення</button>
                    <button class="message-filter-btn" data-type="user">Тільки від користувача</button>
                    <button class="message-filter-btn" data-type="admin">Тільки від адмінів</button>
                `;
                
                chatContainer.parentNode.insertBefore(filtersDiv, chatContainer);
                
                document.querySelectorAll('.message-filter-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.message-filter-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        
                        const filterType = e.target.dataset.type;
                        const filteredMessages = filterMessagesInChat(messages, filterType);
                        renderMessages(filteredMessages);
                    });
                });
            }
            
            // Фільтрація повідомлень в чаті
            function filterMessagesInChat(messages, filterType = 'all') {
                if (filterType === 'all') return messages;
                
                return messages.filter(message => {
                    if (filterType === 'user') return message.sender_type === 'user';
                    if (filterType === 'admin') return message.sender_type === 'admin';
                    return true;
                });
            }
            
            // Відображення повідомлень
            function renderMessages(messages) {
                if (!chatContainer) return;
                
                chatContainer.innerHTML = '';
                
                messages.forEach(message => {
                    addMessageToChat(message.message_text, message.sender_type === 'user', message.sent_at);
                });
                
                const filterInfo = document.createElement('div');
                filterInfo.style.cssText = 'text-align: center; color: #666; font-size: 12px; margin-top: 10px;';
                filterInfo.textContent = `Показано ${messages.length} повідомлень`;
                chatContainer.appendChild(filterInfo);
                
                scrollToBottom();
            }
            
            // Додавання повідомлення до чату
            function addMessageToChat(text, isUser, timestamp) {
                if (!chatContainer) return;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isUser ? 'user' : 'admin'}`;
                
                const timeStr = formatTime(timestamp);
                
                messageDiv.innerHTML = `
                    ${text}
                    <div class="message-time">${timeStr}</div>
                `;
                
                chatContainer.appendChild(messageDiv);
            }
            
            // Відправка відповіді
            function sendReply() {
                if (!replyTextArea || !currentChatId) return;
                
                const message = replyTextArea.value.trim();
                if (!message) return;
                
                console.log(`Відправка відповіді в чат ${currentChatId}: ${message}`);
                
                addMessageToChat(message, false, new Date().toISOString());
                replyTextArea.value = '';
                
                const data = {
                    action: 'admin_reply',
                    chat_id: currentChatId,
                    message: message,
                    admin_id: window.Telegram?.WebApp?.initDataUnsafe?.user?.id,
                    timestamp: new Date().toISOString()
                };
                
                try {
                    window.Telegram.WebApp.sendData(JSON.stringify(data));
                    console.log('Відповідь адміна надіслано успішно');
                } catch (error) {
                    console.error('Помилка відправки відповіді:', error);
                }
                
                setTimeout(loadAllChats, 1000);
            }
            
            // Вставка шаблону відповіді
            function insertTemplate(text) {
                if (replyTextArea) {
                    replyTextArea.value = text;
                    replyTextArea.focus();
                }
            }
            
            // Блокування користувача
            function blockUser() {
                if (!currentChatId) return;
                
                if (confirm('Ви впевнені, що хочете заблокувати цього користувача?')) {
                    const data = {
                        action: 'block_user',
                        chat_id: currentChatId,
                        admin_id: window.Telegram?.WebApp?.initDataUnsafe?.user?.id
                    };
                    
                    try {
                        window.Telegram.WebApp.sendData(JSON.stringify(data));
                        console.log('Користувача заблоковано');
                    } catch (error) {
                        console.error('Помилка блокування:', error);
                    }
                }
            }
            
            // Закриття чату
            function closeCurrentChat() {
                if (!currentChatId) return;
                
                if (confirm('Закрити цей чат?')) {
                    const data = {
                        action: 'close_chat',
                        chat_id: currentChatId,
                        admin_id: window.Telegram?.WebApp?.initDataUnsafe?.user?.id
                    };
                    
                    try {
                        window.Telegram.WebApp.sendData(JSON.stringify(data));
                        console.log('Чат закрито');
                        
                        document.getElementById('noChatSelected').style.display = 'flex';
                        document.getElementById('chatArea').style.display = 'none';
                        currentChatId = null;
                        
                    } catch (error) {
                        console.error('Помилка закриття чату:', error);
                    }
                }
            }
            
            // Форматування часу
            function formatTime(timestamp) {
                if (!timestamp) return '';
                
                const date = new Date(timestamp);
                const now = new Date();
                
                if (date.toDateString() === now.toDateString()) {
                    return date.toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit' });
                } else {
                    return date.toLocaleDateString('uk-UA', { 
                        day: '2-digit', 
                        month: '2-digit',
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                }
            }
            
            // Прокрутка до низу
            function scrollToBottom() {
                if (chatContainer) {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            }
            
            // Події
            if (userFilter) {
                userFilter.addEventListener('change', (e) => {
                    selectedUserId = e.target.value;
                    renderChatList();
                });
            }
            
            if (searchBox) {
                searchBox.addEventListener('input', renderChatList);
            }
            
            if (sendReplyBtn) {
                sendReplyBtn.addEventListener('click', sendReply);
            }
            
            if (replyTextArea) {
                replyTextArea.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendReply();
                    }
                });
            }
            
            // Обробники фільтрів статусу
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    currentFilter = e.target.dataset.filter;
                    renderChatList();
                });
            });
            
            // Глобальні функції для HTML
            window.blockUser = blockUser;
            window.closeCurrentChat = closeCurrentChat;
            window.insertTemplate = insertTemplate;
            window.sendReply = sendReply;
            
            // АВТОМАТИЧНЕ ОНОВЛЕННЯ кожні 10 секунд
            updateInterval = setInterval(() => {
                loadAllChats();
                if (currentChatId) {
                    loadChatHistory(currentChatId);
                }
            }, 10000);
            
            // Очищуємо інтервал при закритті
            window.addEventListener('beforeunload', () => {
                if (updateInterval) {
                    clearInterval(updateInterval);
                }
            });
            
            // Початкова ініціалізація
            console.log('Ініціалізація адмін-панелі...');
            loadAllChats();
            
            console.log('Адмін-панель ініціалізовано успішно!');
        }
    </script>
</body>
</html>
