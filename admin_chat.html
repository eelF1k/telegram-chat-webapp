<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ†Ô∏è –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å —á–∞—Ç—ñ–≤</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        .admin-container {
            width: 100%;
            max-width: 1200px;
            height: 90vh;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            display: flex;
            overflow: hidden;
        }

        /* –ü–∞–Ω–µ–ª—å –∑–ª—ñ–≤–∞ - —Å–ø–∏—Å–æ–∫ —á–∞—Ç—ñ–≤ */
        .chat-list-panel {
            width: 350px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-size: 18px;
            font-weight: 600;
        }

        .connection-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 10px;
            font-weight: bold;
        }

        .connection-status.connected {
            background-color: #4CAF50;
        }

        .connection-status.connecting {
            background-color: #FF9800;
        }

        .connection-status.disconnected {
            background-color: #9E9E9E;
        }

        .connection-status.error {
            background-color: #F44336;
        }

        .chat-filters {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
        }

        .filter-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 5px 12px;
            border: none;
            border-radius: 15px;
            background: #e9ecef;
            color: #495057;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
        }

        .filter-btn:hover {
            background: #5a6fd8;
            color: white;
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .chat-item {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }

        .chat-item:hover {
            background: #f1f3f4;
        }

        .chat-item.active {
            background: #e3f2fd;
            border-right: 3px solid #667eea;
        }

        .chat-item.has-unread {
            background: #fff3e0;
        }

        .chat-user-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .chat-preview {
            font-size: 13px;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .chat-time {
            font-size: 11px;
            color: #adb5bd;
        }

        .unread-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #dc3545;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: bold;
        }

        /* –ü–∞–Ω–µ–ª—å —Å–ø—Ä–∞–≤–∞ - —á–∞—Ç */
        .chat-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 20px;
            background: #ffffff;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-user-info h3 {
            margin: 0;
            color: #2c3e50;
        }

        .chat-user-meta {
            font-size: 13px;
            color: #6c757d;
            margin-top: 2px;
        }

        .chat-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-block {
            background: #dc3545;
            color: white;
        }

        .btn-block:hover {
            background: #c82333;
        }

        .btn-close {
            background: #6c757d;
            color: white;
        }

        .btn-close:hover {
            background: #5a6268;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            max-width: 80%;
        }

        .message.user-message {
            margin-left: auto;
            background: #e3f2fd;
            color: #1976d2;
            padding: 12px 16px;
            border-radius: 15px 15px 5px 15px;
            border-left: 3px solid #2196f3;
        }

        .message.admin-message {
            margin-right: auto;
            background: white;
            color: #2c3e50;
            padding: 12px 16px;
            border-radius: 15px 15px 15px 5px;
            border-left: 3px solid #667eea;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .message.synced {
            opacity: 0.8;
        }

        .message.synced::after {
            content: " (—Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–æ)";
            font-size: 11px;
            opacity: 0.6;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.6;
            margin-top: 5px;
        }

        .system-message {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            margin: 15px 0;
            padding: 10px;
            background: #e9ecef;
            border-radius: 10px;
        }

        .typing-indicator {
            padding: 10px 20px;
            color: #6c757d;
            font-style: italic;
            background: #e9ecef;
            margin: 10px 0;
            border-radius: 15px;
            display: none;
        }

        .empty-chat {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #adb5bd;
            text-align: center;
        }

        .empty-chat-content h3 {
            margin-bottom: 10px;
        }

        /* –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥—É */
        .message-input-panel {
            padding: 20px;
            background: white;
            border-top: 1px solid #e9ecef;
        }

        .quick-replies {
            margin-bottom: 10px;
        }

        .quick-reply-btn {
            margin-right: 10px;
            margin-bottom: 5px;
            padding: 5px 10px;
            border: 1px solid #dee2e6;
            background: #f8f9fa;
            color: #495057;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-reply-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .message-input-container {
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #dee2e6;
            border-radius: 25px;
            outline: none;
            font-size: 14px;
            resize: none;
            min-height: 20px;
            max-height: 100px;
        }

        .message-input:focus {
            border-color: #667eea;
        }

        .send-btn {
            padding: 12px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .send-btn:hover {
            background: #5a6fd8;
        }

        .send-btn:disabled {
            background: #adb5bd;
            cursor: not-allowed;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .admin-container {
                height: 100vh;
                border-radius: 0;
            }
            
            .chat-list-panel {
                width: 100%;
                display: none;
            }
            
            .chat-list-panel.mobile-visible {
                display: flex;
            }
            
            .chat-panel.mobile-hidden {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- –ü–∞–Ω–µ–ª—å —Å–ø–∏—Å–∫—É —á–∞—Ç—ñ–≤ -->
        <div class="chat-list-panel" id="chatListPanel">
            <div class="panel-header">
                <div class="panel-title">üõ†Ô∏è –ß–∞—Ç–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏</div>
                <div class="connection-status connecting" id="connectionStatus">–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...</div>
            </div>

            <div class="chat-filters">
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all">–í—Å—ñ</button>
                    <button class="filter-btn" data-filter="new">–ù–æ–≤—ñ</button>
                    <button class="filter-btn" data-filter="pending">–û—á—ñ–∫—É—é—Ç—å</button>
                    <button class="filter-btn" data-filter="answered">–í—ñ–¥–ø–æ–≤—ñ–¥–∞–Ω–æ</button>
                    <button class="filter-btn" data-filter="closed">–ó–∞–∫—Ä–∏—Ç—ñ</button>
                </div>
            </div>

            <div class="chat-list" id="chatList">
                <div class="system-message">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —á–∞—Ç—ñ–≤...</div>
            </div>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å —á–∞—Ç—É -->
        <div class="chat-panel" id="chatPanel">
            <div class="empty-chat" id="emptyChat">
                <div class="empty-chat-content">
                    <h3>–û–±–µ—Ä—ñ—Ç—å —á–∞—Ç –∑—ñ —Å–ø–∏—Å–∫—É</h3>
                    <p>–í–∏–±–µ—Ä—ñ—Ç—å —Ä–æ–∑–º–æ–≤—É –∑ –ª—ñ–≤–æ—ó –ø–∞–Ω–µ–ª—ñ –¥–ª—è –ø–æ—á–∞—Ç–∫—É —Ä–æ–±–æ—Ç–∏</p>
                </div>
            </div>

            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç—É (–ø—Ä–∏—Ö–æ–≤–∞–Ω–∏–π –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º) -->
            <div class="chat-header" id="chatHeader" style="display: none;">
                <div class="chat-user-info">
                    <h3 id="chatUserName">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</h3>
                    <div class="chat-user-meta" id="chatUserMeta">–û—Å—Ç–∞–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å: –Ω–µ–≤—ñ–¥–æ–º–æ</div>
                </div>
                <div class="chat-actions">
                    <button class="action-btn btn-block" onclick="blockUser()">–ó–∞–±–ª–æ–∫—É–≤–∞—Ç–∏</button>
                    <button class="action-btn btn-close" onclick="closeChat()">–ó–∞–∫—Ä–∏—Ç–∏ —á–∞—Ç</button>
                </div>
            </div>

            <!-- –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —á–∞—Ç—É (–ø—Ä–∏—Ö–æ–≤–∞–Ω—ñ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º) -->
            <div class="chat-messages" id="chatMessages" style="display: none;">
                <div class="system-message">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó...</div>
            </div>

            <!-- –Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä—É —Ç–µ–∫—Å—Ç—É -->
            <div class="typing-indicator" id="typingIndicator">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –¥—Ä—É–∫—É—î...</div>

            <!-- –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥—É (–ø—Ä–∏—Ö–æ–≤–∞–Ω–∞ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º) -->
            <div class="message-input-panel" id="messageInputPanel" style="display: none;">
                <div class="quick-replies">
                    <button class="quick-reply-btn" onclick="insertQuickReply('–î—è–∫—É—î–º–æ –∑–∞ –∑–≤–µ—Ä–Ω–µ–Ω–Ω—è! –†–æ–∑–≥–ª—è–¥–∞—î–º–æ –≤–∞—à–µ –ø–∏—Ç–∞–Ω–Ω—è.')">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å</button>
                    <button class="quick-reply-btn" onclick="insertQuickReply('–ë—É–¥—å –ª–∞—Å–∫–∞, –Ω–∞–¥–∞–π—Ç–µ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –¥–µ—Ç–∞–ª—ñ –≤–∞—à–æ–≥–æ –∑–∞–ø–∏—Ç—É.')">–ó–∞–ø–∏—Ç –¥–µ—Ç–∞–ª–µ–π</button>
                    <button class="quick-reply-btn" onclick="insertQuickReply('–ü—Ä–æ–±–ª–µ–º—É –≤–∏—Ä—ñ—à–µ–Ω–æ! –Ø–∫—â–æ —É –≤–∞—Å —î —ñ–Ω—à—ñ –ø–∏—Ç–∞–Ω–Ω—è, –∑–≤–µ—Ä—Ç–∞–π—Ç–µ—Å—è.')">–ü—Ä–æ–±–ª–µ–º—É –≤–∏—Ä—ñ—à–µ–Ω–æ</button>
                </div>
                <div class="message-input-container">
                    <textarea class="message-input" id="messageInput" placeholder="–í–≤–µ–¥—ñ—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥—å..." rows="1"></textarea>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ
        let ws = null;
        let connectionId = null;
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 5;
        let reconnectInterval = 1000;
        let adminId = null;
        let currentChatId = null;
        let allChats = [];
        let currentFilter = 'all';
        let isTyping = false;
        let typingTimeout = null;

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
        document.addEventListener('DOMContentLoaded', function() {
            // –û—Ç—Ä–∏–º—É—î–º–æ adminId –∑ URL –∞–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
            const urlParams = new URLSearchParams(window.location.search);
            adminId = urlParams.get('admin_id') || '794238641';
            
            connectWebSocket();
            setupEventListeners();
        });

        // WebSocket –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–º –ø–µ—Ä–µ–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è–º
        function connectWebSocket() {
            if (ws && (ws.readyState === WebSocket.CONNECTING || ws.readyState === WebSocket.OPEN)) {
                return;
            }
            
            updateConnectionStatus('–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...', 'connecting');
            
            const wsUrl = `ws://localhost:8001/admin?admin_id=${adminId}`;
            ws = new WebSocket(wsUrl);

            ws.onopen = function() {
                console.log('Admin WebSocket –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ');
                updateConnectionStatus('–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ', 'connected');
                reconnectAttempts = 0;
                reconnectInterval = 1000;
                
                // –ó–∞–ø–∏—Ç—É—î–º–æ —Å–ø–∏—Å–æ–∫ —á–∞—Ç—ñ–≤
                requestChatList();
            };

            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    console.log('–û—Ç—Ä–∏–º–∞–Ω–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:', data);
                    
                    switch(data.type) {
                        case 'admin_connection_established':
                            connectionId = data.connection_id;
                            console.log(`–ê–¥–º—ñ–Ω-–∑'—î–¥–Ω–∞–Ω–Ω—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: ${connectionId}`);
                            break;
                            
                        case 'chat_list':
                            displayChatList(data.chats);
                            break;
                            
                        case 'chat_history':
                            displayChatHistory(data.messages);
                            break;
                            
                        case 'new_message':
                            if (data.sender_type === 'user') {
                                handleNewUserMessage(data);
                            } else if (data.sender_type === 'admin') {
                                // –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥ —ñ–Ω—à–æ–≥–æ –∞–¥–º—ñ–Ω–∞ –∞–±–æ –∑ —ñ–Ω—à–æ—ó –≤–∫–ª–∞–¥–∫–∏
                                const isFromOtherConnection = data.connection_id !== connectionId;
                                if (isFromOtherConnection && data.chat_id == currentChatId) {
                                    displayAdminMessage(data.message, data.timestamp, true);
                                }
                            }
                            break;
                            
                        case 'admin_message_sent_confirmation':
                            // –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó
                            if (data.chat_id == currentChatId) {
                                // –ú–æ–∂–µ–º–æ –æ–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
                            }
                            break;
                            
                        case 'typing':
                            if (data.chat_id == currentChatId) {
                                if (data.is_typing) {
                                    showTypingIndicator();
                                } else {
                                    hideTypingIndicator();
                                }
                            }
                            break;
                            
                        default:
                            console.log('–ù–µ–≤—ñ–¥–æ–º–∏–π —Ç–∏–ø –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:', data.type);
                    }
                } catch (e) {
                    console.error('–ü–æ–º–∏–ª–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥—É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:', e);
                }
            };

            ws.onclose = function(event) {
                console.log('Admin WebSocket –∑–∞–∫—Ä–∏—Ç–æ:', event.code, event.reason);
                updateConnectionStatus('–í—ñ–¥–∫–ª—é—á–µ–Ω–æ', 'disconnected');
                
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    updateConnectionStatus(`–ü–µ—Ä–µ–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è... (${reconnectAttempts}/${maxReconnectAttempts})`, 'connecting');
                    
                    setTimeout(() => {
                        connectWebSocket();
                        reconnectInterval = Math.min(reconnectInterval * 2, 30000);
                    }, reconnectInterval);
                } else {
                    updateConnectionStatus('–ó\'—î–¥–Ω–∞–Ω–Ω—è –≤—Ç—Ä–∞—á–µ–Ω–æ', 'error');
                    showSystemMessage('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏ –∑\'—î–¥–Ω–∞–Ω–Ω—è. –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Å—Ç–æ—Ä—ñ–Ω–∫—É.');
                }
            };

            ws.onerror = function(error) {
                console.error('Admin WebSocket –ø–æ–º–∏–ª–∫–∞:', error);
                updateConnectionStatus('–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è', 'error');
            };
        }

        // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤ –ø–æ–¥—ñ–π
        function setupEventListeners() {
            // –§—ñ–ª—å—Ç—Ä–∏ —á–∞—Ç—ñ–≤
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    setActiveFilter(this.dataset.filter);
                });
            });

            // –í–≤–µ–¥–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
            const messageInput = document.getElementById('messageInput');
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                } else {
                    startTyping();
                }
            });

            messageInput.addEventListener('keyup', function(e) {
                if (this.value.trim() === '') {
                    stopTyping();
                }
            });

            messageInput.addEventListener('blur', stopTyping);

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è textarea
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
        }

        // –§—É–Ω–∫—Ü—ñ—ó WebSocket –∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—ó
        function requestChatList() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'get_all_chats'
                }));
            }
        }

        function requestChatHistory(chatId) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'get_chat_history',
                    chat_id: chatId
                }));
            }
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message || !ws || ws.readyState !== WebSocket.OPEN || !currentChatId) {
                return;
            }
            
            // –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ª–æ–∫–∞–ª—å–Ω–æ
            displayAdminMessage(message, new Date().toISOString(), false);
            
            // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            ws.send(JSON.stringify({
                type: 'send_message',
                chat_id: currentChatId,
                message: message
            }));
            
            messageInput.value = '';
            messageInput.style.height = 'auto';
            stopTyping();
        }

        // –§—É–Ω–∫—Ü—ñ—ó –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
        function displayChatList(chats) {
            allChats = chats;
            const chatList = document.getElementById('chatList');
            
            if (chats.length === 0) {
                chatList.innerHTML = '<div class="system-message">–ß–∞—Ç—ñ–≤ –ø–æ–∫–∏ –Ω–µ–º–∞—î</div>';
                return;
            }
            
            const filteredChats = filterChats(chats, currentFilter);
            
            chatList.innerHTML = '';
            filteredChats.forEach(chat => {
                const chatItem = createChatItem(chat);
                chatList.appendChild(chatItem);
            });
        }

        function createChatItem(chat) {
            const item = document.createElement('div');
            item.className = 'chat-item';
            item.dataset.chatId = chat.chat_id;
            
            if (chat.unread_count > 0) {
                item.classList.add('has-unread');
            }
            
            const userName = chat.first_name || '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á';
            const lastMessage = chat.last_message_time ? 
                new Date(chat.last_message_time).toLocaleString('uk-UA') : 
                '–ù–µ–º–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å';
                
            item.innerHTML = `
                <div class="chat-user-name">${escapeHtml(userName)}</div>
                <div class="chat-preview">ID: ${chat.user_id} | –°—Ç–∞—Ç—É—Å: ${chat.status || '–Ω–æ–≤–∏–π'}</div>
                <div class="chat-time">${lastMessage}</div>
                ${chat.unread_count > 0 ? `<div class="unread-badge">${chat.unread_count}</div>` : ''}
            `;
            
            item.addEventListener('click', () => selectChat(chat));
            
            return item;
        }

        function selectChat(chat) {
            currentChatId = chat.chat_id;
            
            // –û–Ω–æ–≤–ª—é—î–º–æ –∞–∫—Ç–∏–≤–Ω–∏–π —á–∞—Ç —É —Å–ø–∏—Å–∫—É
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const selectedItem = document.querySelector(`[data-chat-id="${chat.chat_id}"]`);
            if (selectedItem) {
                selectedItem.classList.add('active');
                selectedItem.classList.remove('has-unread');
                const badge = selectedItem.querySelector('.unread-badge');
                if (badge) badge.remove();
            }
            
            // –ü–æ–∫–∞–∑—É—î–º–æ –ø–∞–Ω–µ–ª—å —á–∞—Ç—É
            showChatPanel(chat);
            
            // –ó–∞–ø–∏—Ç—É—î–º–æ —ñ—Å—Ç–æ—Ä—ñ—é
            requestChatHistory(chat.chat_id);
        }

        function showChatPanel(chat) {
            // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –∑–∞–≥–ª—É—à–∫—É
            document.getElementById('emptyChat').style.display = 'none';
            
            // –ü–æ–∫–∞–∑—É—î–º–æ –µ–ª–µ–º–µ–Ω—Ç–∏ —á–∞—Ç—É
            document.getElementById('chatHeader').style.display = 'flex';
            document.getElementById('chatMessages').style.display = 'block';
            document.getElementById('messageInputPanel').style.display = 'block';
            
            // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
            document.getElementById('chatUserName').textContent = chat.first_name || '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á';
            document.getElementById('chatUserMeta').textContent = `ID: ${chat.user_id} | –û—Å—Ç–∞–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å: ${
                chat.last_message_time ? 
                new Date(chat.last_message_time).toLocaleString('uk-UA') : 
                '–Ω–µ–≤—ñ–¥–æ–º–æ'
            }`;
        }

        function displayChatHistory(messages) {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            if (messages.length === 0) {
                chatMessages.innerHTML = '<div class="system-message">–Ü—Å—Ç–æ—Ä—ñ—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –ø–æ—Ä–æ–∂–Ω—è</div>';
                return;
            }
            
            messages.forEach(msg => {
                if (msg.sender_type === 'user') {
                    displayUserMessage(msg.message_text, msg.sent_at);
                } else {
                    displayAdminMessage(msg.message_text, msg.sent_at, true);
                }
            });
            
            scrollToBottom();
        }

        function displayUserMessage(message, timestamp) {
            const chatMessages = document.getElementById('chatMessages');
            const messageEl = document.createElement('div');
            messageEl.className = 'message user-message';
            
            const time = new Date(timestamp).toLocaleTimeString('uk-UA', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            messageEl.innerHTML = `
                <div class="message-content">${escapeHtml(message)}</div>
                <div class="message-time">${time}</div>
            `;
            
            chatMessages.appendChild(messageEl);
            scrollToBottom();
        }

        function displayAdminMessage(message, timestamp, fromHistory = false) {
            const chatMessages = document.getElementById('chatMessages');
            const messageEl = document.createElement('div');
            messageEl.className = `message admin-message ${fromHistory ? 'synced' : ''}`;
            
            const time = new Date(timestamp).toLocaleTimeString('uk-UA', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            messageEl.innerHTML = `
                <div class="message-content">${escapeHtml(message)}</div>
                <div class="message-time">${time}</div>
            `;
            
            chatMessages.appendChild(messageEl);
            scrollToBottom();
        }

        function handleNewUserMessage(data) {
            // –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫ —á–∞—Ç—ñ–≤
            requestChatList();
            
            // –Ø–∫—â–æ —Ü–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ –ø–æ—Ç–æ—á–Ω–æ–º—É —á–∞—Ç—ñ
            if (data.chat_id == currentChatId) {
                displayUserMessage(data.message, data.timestamp);
                playNotificationSound();
            } else {
                // –ü–æ–∫–∞–∑—É—î–º–æ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ –Ω–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
                showNotification(`–ù–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ —á–∞—Ç—ñ ${data.chat_id}`);
            }
        }

        // –î–æ–ø–æ–º—ñ–∂–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó
        function updateConnectionStatus(status, className) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.textContent = status;
            statusEl.className = `connection-status ${className}`;
        }

        function setActiveFilter(filter) {
            currentFilter = filter;
            
            // –û–Ω–æ–≤–ª—é—î–º–æ –∞–∫—Ç–∏–≤–Ω—É –∫–Ω–æ–ø–∫—É
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
            
            // –ü–µ—Ä–µ—Ñ—ñ–ª—å—Ç—Ä–æ–≤—É—î–º–æ —á–∞—Ç–∏
            displayChatList(allChats);
        }

        function filterChats(chats, filter) {
            switch (filter) {
                case 'new':
                    return chats.filter(chat => chat.status === 'new');
                case 'pending':
                    return chats.filter(chat => chat.status === 'pending');
                case 'answered':
                    return chats.filter(chat => chat.status === 'answered');
                case 'closed':
                    return chats.filter(chat => chat.status === 'closed');
                default:
                    return chats;
            }
        }

        function insertQuickReply(text) {
            const messageInput = document.getElementById('messageInput');
            messageInput.value = text;
            messageInput.focus();
        }

        function startTyping() {
            if (!isTyping && ws && ws.readyState === WebSocket.OPEN && currentChatId) {
                isTyping = true;
                ws.send(JSON.stringify({
                    type: 'typing',
                    chat_id: currentChatId,
                    is_typing: true
                }));
            }
            
            if (typingTimeout) {
                clearTimeout(typingTimeout);
            }
            
            typingTimeout = setTimeout(stopTyping, 3000);
        }

        function stopTyping() {
            if (isTyping && ws && ws.readyState === WebSocket.OPEN && currentChatId) {
                isTyping = false;
                ws.send(JSON.stringify({
                    type: 'typing',
                    chat_id: currentChatId,
                    is_typing: false
                }));
            }
            
            if (typingTimeout) {
                clearTimeout(typingTimeout);
                typingTimeout = null;
            }
        }

        function showTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'block';
            scrollToBottom();
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        function scrollToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function playNotificationSound() {
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmMdBDqP2O3LbSkCKnW/8u2rZh0HJYjG8OC7fkgOH2et2OZ1Qw0SSpru7qQ=');
                audio.play().catch(() => {});
            } catch (e) {}
        }

        function showNotification(message) {
            // –ú–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –±—Ä–∞—É–∑–µ—Ä–Ω—ñ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
            if (Notification.permission === 'granted') {
                new Notification('–ù–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è', { body: message });
            }
        }

        function showSystemMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageEl = document.createElement('div');
            messageEl.className = 'system-message';
            messageEl.textContent = message;
            chatMessages.appendChild(messageEl);
            scrollToBottom();
        }

        // –î—ñ—ó –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        function blockUser() {
            if (!currentChatId) return;
            
            if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –∑–∞–±–ª–æ–∫—É–≤–∞—Ç–∏ —Ü—å–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞?')) {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: 'block_user',
                        chat_id: currentChatId
                    }));
                    
                    showSystemMessage('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–∏–π');
                }
            }
        }

        function closeChat() {
            if (!currentChatId) return;
            
            if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –∑–∞–∫—Ä–∏—Ç–∏ —Ü–µ–π —á–∞—Ç?')) {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: 'close_chat',
                        chat_id: currentChatId
                    }));
                    
                    showSystemMessage('–ß–∞—Ç –∑–∞–∫—Ä–∏—Ç–æ');
                    
                    // –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫ —á–∞—Ç—ñ–≤
                    setTimeout(() => requestChatList(), 500);
                }
            }
        }

        // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ WebSocket –ø—Ä–∏ –∑–∞–∫—Ä–∏—Ç—Ç—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        window.addEventListener('beforeunload', function() {
            if (ws) {
                ws.close();
            }
        });

        // –ó–∞–ø–∏—Ç—É—î–º–æ –¥–æ–∑–≤—ñ–ª –Ω–∞ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
    </script>
</body>
</html>
