<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Адмін-панель чату</title>
    <style>
        * {
            margin: 0;
            padding: 0; 
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            height: 100vh;
            display: flex;
            background: #f5f6fa;
        }
        
        .sidebar {
            width: 350px;
            background: white;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-header {
            background: #0088cc;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .filters {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .filter-btn {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 8px 12px;
            margin: 2px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .filter-btn.active {
            background: #0088cc;
            color: white;
        }
        
        .search-box {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            margin-top: 10px;
        }
        
        .chat-list {
            flex: 1;
            overflow-y: auto;
        }
        
        .chat-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .chat-item:hover {
            background: #f8f9fa;
        }
        
        .chat-item.active {
            background: #e3f2fd;
            border-left: 3px solid #0088cc;
        }
        
        .chat-item.unread {
            background: #fff3e0;
            font-weight: bold;
        }
        
        .chat-item.unread::before {
            content: '●';
            color: #ff9800;
            font-size: 20px;
            margin-right: 10px;
        }
        
        .chat-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .chat-preview {
            font-size: 13px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .chat-time {
            font-size: 11px;
            color: #999;
        }
        
        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            background: white;
            padding: 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-info h3 {
            margin-bottom: 5px;
        }
        
        .user-status {
            font-size: 12px;
            color: #666;
        }
        
        .quick-actions {
            display: flex;
            gap: 10px;
        }
        
        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn-block {
            background: #ff4444;
            color: white;
        }
        
        .btn-close {
            background: #666;
            color: white;
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #fafafa;
        }
        
        .message {
            margin: 15px 0;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 70%;
            word-wrap: break-word;
        }
        
        .message.user {
            background: #e3f2fd;
            margin-left: auto;
            text-align: right;
        }
        
        .message.admin {
            background: white;
            border: 1px solid #ddd;
        }
        
        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 5px;
        }
        
        .reply-area {
            background: white;
            padding: 20px;
            border-top: 1px solid #ddd;
        }
        
        .templates {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .template-btn {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .template-btn:hover {
            background: #e9ecef;
        }
        
        .reply-input {
            display: flex;
            gap: 10px;
        }
        
        .reply-textarea {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 15px;
            resize: none;
            min-height: 50px;
        }
        
        .send-reply-btn {
            background: #0088cc;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 15px;
            cursor: pointer;
        }
        
        .no-chat-selected {
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
            color: #666;
            font-size: 18px;
        }
        
        .typing-indicator {
            padding: 10px 20px;
            font-style: italic;
            color: #666;
            background: #f0f0f0;
            margin: 5px 0;
            border-radius: 10px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .typing-indicator.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Чати підтримки</h2>
            <div style="font-size: 12px; margin-top: 5px;" id="chatCount">0 активних чатів</div>
        </div>
        
        <div class="filters">
            <div>
                <button class="filter-btn active" data-filter="all">Всі</button>
                <button class="filter-btn" data-filter="new">Нові</button>
                <button class="filter-btn" data-filter="waiting">Очікують</button>
                <button class="filter-btn" data-filter="answered">Відповідано</button>
                <button class="filter-btn" data-filter="closed">Закриті</button>
            </div>
            <input type="text" class="search-box" placeholder="Пошук користувачів..." id="searchBox">
        </div>
        
        <div class="chat-list" id="chatList">
            <!-- Чати будуть додані динамічно -->
        </div>
    </div>
    
    <div class="main-area">
        <div id="noChatSelected" class="no-chat-selected">
            Оберіть чат зі списку
        </div>
        
        <div id="chatArea" style="display: none; flex-direction: column; height: 100%;">
            <div class="chat-header">
                <div class="user-info">
                    <h3 id="currentUserName">Користувач</h3>
                    <div class="user-status" id="currentUserStatus">Остання активність: невідомо</div>
                </div>
                
                <div class="quick-actions">
                    <button class="action-btn btn-block" onclick="blockUser()">Заблокувати</button>
                    <button class="action-btn btn-close" onclick="closeCurrentChat()">Закрити чат</button>
                </div>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <!-- Повідомлення будуть додані динамічно -->
            </div>
            
            <div class="typing-indicator" id="typingIndicator">
                Користувач друкує...
            </div>
            
            <div class="reply-area">
                <div class="templates">
                    <button class="template-btn" onclick="insertTemplate('Дякуємо за звернення! Ми вже працюємо над вашим питанням.')">Стандартна відповідь</button>
                    <button class="template-btn" onclick="insertTemplate('Будь ласка, надайте більше деталей.')">Запит деталей</button>
                    <button class="template-btn" onclick="insertTemplate('Вашу проблему вирішено. Дякуємо за звернення!')">Проблему вирішено</button>
                </div>
                
                <div class="reply-input">
                    <textarea id="replyText" class="reply-textarea" placeholder="Введіть відповідь..."></textarea>
                    <button class="send-reply-btn" onclick="sendReply()">Відправити</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // БЕЗПЕЧНА ІНІЦІАЛІЗАЦІЯ Telegram WebApp
    let tg;
    
    if (window.Telegram && window.Telegram.WebApp) {
        tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        console.log('Telegram WebApp для адміна ініціалізовано успішно');
    } else {
        console.error('Telegram WebApp API недоступний');
        document.body.innerHTML = '<div style="text-align: center; padding: 50px; font-family: Arial; color: #666;">⚠️ Адмін-панель працює тільки в Telegram WebApp<br><br>Відкрийте через команду /webchat в боті!</div>';
    }
    
    // Решта коду тільки якщо tg існує
    if (tg) {
        // Глобальні змінні
        let currentChatId = null;
        let allChats = [];
        let currentFilter = 'all';
        let selectedUserId = null;
        let updateInterval = null;
        
        // Шаблони відповідей
        const responseTemplates = [
            'Дякуємо за звернення! Ми вже працюємо над вашим питанням.',
            'Будь ласка, надайте більше деталей.',
            'Вашу проблему вирішено. Дякуємо за звернення!',
            'Передаю ваше питання спеціалісту.',
            'На жаль, ця функція наразі недоступна. Слідкуйте за оновленнями.',
            'Ваш запит опрацьовується. Очікуйте відповіді найближчим часом.',
            'Спробуйте перезапустити бота командою /start',
            'З технічних причин сервіс тимчасово недоступний.'
        ];
        
        // DOM елементи
        const chatList = document.getElementById('chatList');
        const chatContainer = document.getElementById('chatMessages');
        const replyTextArea = document.getElementById('replyText');
        const sendReplyBtn = document.querySelector('.send-reply-btn');
        const userFilter = document.getElementById('userFilter');
        const searchBox = document.getElementById('searchBox');
        const chatCount = document.getElementById('chatCount');
        const typingIndicator = document.getElementById('typingIndicator');
        
        // Завантаження всіх чатів з локального збереження (для тестування)
        async function loadAllChats() {
            try {
                console.log('Завантаження списку чатів...');
                
                // Моковані дані для тестування (замініть на реальний API)
                const mockChats = [
                    {
                        chat_id: 1,
                        user_id: 6778182293,
                        first_name: 'Тестовий',
                        username: 'testuser',
                        status: 'new',
                        message_count: 3,
                        last_message: 'Привіт! Можете допомогти?',
                        updated_at: new Date().toISOString(),
                        unread_count: 2
                    },
                    {
                        chat_id: 2,
                        user_id: 123456789,
                        first_name: 'Інший',
                        username: 'anotheruser',
                        status: 'waiting',
                        message_count: 1,
                        last_message: 'Чекаю відповіді',
                        updated_at: new Date(Date.now() - 3600000).toISOString(),
                        unread_count: 1
                    }
                ];
                
                // В реальному проекті замініть на:
                // const response = await fetch('/api/admin/chats');
                // if (response.ok) {
                //     allChats = await response.json();
                // }
                
                allChats = mockChats;
                updateUserFilter();
                renderChatList();
                
            } catch (error) {
                console.error('Помилка завантаження чатів:', error);
            }
        }
        
        // Оновлення фільтра користувачів
        function updateUserFilter() {
            if (!userFilter) return;
            
            const uniqueUsers = new Map();
            
            allChats.forEach(chat => {
                if (chat.user_id && !uniqueUsers.has(chat.user_id)) {
                    uniqueUsers.set(chat.user_id, {
                        id: chat.user_id,
                        name: chat.first_name || 'Користувач',
                        username: chat.username || 'невідомо'
                    });
                }
            });
            
            userFilter.innerHTML = '<option value="">Всі користувачі</option>';
            
            uniqueUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.name} (@${user.username})`;
                userFilter.appendChild(option);
            });
        }
        
        // Фільтрація та відображення списку чатів
        function renderChatList() {
            if (!chatList) return;
            
            const searchTerm = searchBox ? searchBox.value.toLowerCase() : '';
            
            // Фільтруємо чати
            let filteredChats = allChats.filter(chat => {
                // Фільтр по статусу
                const matchesStatus = currentFilter === 'all' || chat.status === currentFilter;
                
                // Фільтр по користувачу
                const matchesUser = !selectedUserId || chat.user_id == selectedUserId;
                
                // Фільтр по пошуку
                const matchesSearch = !searchTerm || 
                    (chat.first_name && chat.first_name.toLowerCase().includes(searchTerm)) ||
                    (chat.username && chat.username.toLowerCase().includes(searchTerm));
                
                return matchesStatus && matchesUser && matchesSearch;
            });
            
            // Сортуємо по часу оновлення
            filteredChats.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
            
            chatList.innerHTML = '';
            
            if (chatCount) {
                chatCount.textContent = `${filteredChats.length} чатів`;
            }
            
            filteredChats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = `chat-item ${chat.status}`;
                
                if (chat.unread_count > 0) {
                    chatItem.classList.add('unread');
                }
                
                if (currentChatId === chat.chat_id) {
                    chatItem.classList.add('active');
                }
                
                chatItem.onclick = () => selectChat(chat.chat_id);
                
                const lastMessage = chat.last_message || 'Повідомлень немає';
                const timeStr = formatTime(chat.updated_at);
                
                chatItem.innerHTML = `
                    <div class="chat-name">${chat.first_name || 'Користувач'} (@${chat.username || 'невідомо'})</div>
                    <div class="chat-preview">${lastMessage}</div>
                    <div class="chat-time">${timeStr}</div>
                `;
                
                chatList.appendChild(chatItem);
            });
        }
        
        // Вибір чату
        function selectChat(chatId) {
            currentChatId = chatId;
            
            // Оновлюємо активний чат у списку
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
            });
            
            event.target.closest('.chat-item').classList.add('active');
            
            // Показуємо область чату
            const noChatSelected = document.getElementById('noChatSelected');
            const chatArea = document.getElementById('chatArea');
            
            if (noChatSelected) noChatSelected.style.display = 'none';
            if (chatArea) chatArea.style.display = 'flex';
            
            // Завантажуємо історію чату
            loadChatHistory(chatId);
            
            // Оновлюємо інформацію про користувача
            const chat = allChats.find(c => c.chat_id === chatId);
            if (chat) {
                const userNameElement = document.getElementById('currentUserName');
                const userStatusElement = document.getElementById('currentUserStatus');
                
                if (userNameElement) {
                    userNameElement.textContent = `${chat.first_name || 'Користувач'} (@${chat.username || 'невідомо'})`;
                }
                
                if (userStatusElement) {
                    userStatusElement.textContent = `Остання активність: ${formatTime(chat.updated_at)}`;
                }
            }
        }
        
        // Завантаження історії чату
        async function loadChatHistory(chatId) {
            try {
                console.log(`Завантаження історії чату ${chatId}`);
                
                // Моковані повідомлення для тестування
                const mockMessages = [
                    {
                        message_text: 'Привіт! Можете допомогти з проблемою?',
                        sender_type: 'user',
                        sent_at: new Date(Date.now() - 7200000).toISOString()
                    },
                    {
                        message_text: 'Звичайно! Опишіть детальніше вашу проблему.',
                        sender_type: 'admin',
                        sent_at: new Date(Date.now() - 3600000).toISOString()
                    },
                    {
                        message_text: 'У мене не працює функція пошуку курсів',
                        sender_type: 'user',
                        sent_at: new Date(Date.now() - 1800000).toISOString()
                    }
                ];
                
                // В реальному проекті замініть на:
                // const response = await fetch(`/api/admin/chat/${chatId}/messages`);
                // if (response.ok) {
                //     const messages = await response.json();
                //     displayChatHistory(messages);
                // }
                
                displayChatHistory(mockMessages);
                
            } catch (error) {
                console.error('Помилка завантаження історії чату:', error);
            }
        }
        
        // Відображення історії чату
        function displayChatHistory(messages) {
            if (!chatContainer) return;
            
            // Додаємо кнопки фільтрації повідомлень
            if (!document.getElementById('messageFilters')) {
                addMessageFilters(messages);
            }
            
            renderMessages(messages);
        }
        
        // Додавання кнопок фільтрації повідомлень
        function addMessageFilters(messages) {
            const filtersDiv = document.createElement('div');
            filtersDiv.id = 'messageFilters';
            filtersDiv.style.cssText = 'margin-bottom: 15px; text-align: center;';
            filtersDiv.innerHTML = `
                <button class="message-filter-btn active" data-type="all">Всі повідомлення</button>
                <button class="message-filter-btn" data-type="user">Тільки від користувача</button>
                <button class="message-filter-btn" data-type="admin">Тільки від адмінів</button>
            `;
            
            chatContainer.parentNode.insertBefore(filtersDiv, chatContainer);
            
            // Обробники подій для кнопок фільтрації
            document.querySelectorAll('.message-filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.message-filter-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    const filterType = e.target.dataset.type;
                    const filteredMessages = filterMessagesInChat(messages, filterType);
                    renderMessages(filteredMessages);
                });
            });
        }
        
        // Фільтрація повідомлень в чаті
        function filterMessagesInChat(messages, filterType = 'all') {
            if (filterType === 'all') return messages;
            
            return messages.filter(message => {
                if (filterType === 'user') return message.sender_type === 'user';
                if (filterType === 'admin') return message.sender_type === 'admin';
                return true;
            });
        }
        
        // Відображення повідомлень
        function renderMessages(messages) {
            if (!chatContainer) return;
            
            chatContainer.innerHTML = '';
            
            messages.forEach(message => {
                addMessageToChat(message.message_text, message.sender_type === 'user', message.sent_at);
            });
            
            // Інформація про кількість повідомлень
            const filterInfo = document.createElement('div');
            filterInfo.style.cssText = 'text-align: center; color: #666; font-size: 12px; margin-top: 10px;';
            filterInfo.textContent = `Показано ${messages.length} повідомлень`;
            chatContainer.appendChild(filterInfo);
            
            scrollToBottom();
        }
        
        // Додавання повідомлення до чату
        function addMessageToChat(text, isUser, timestamp) {
            if (!chatContainer) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'admin'}`;
            
            const timeStr = formatTime(timestamp);
            
            messageDiv.innerHTML = `
                ${text}
                <div class="message-time">${timeStr}</div>
            `;
            
            chatContainer.appendChild(messageDiv);
        }
        
        // Відправка відповіді
        function sendReply() {
            if (!replyTextArea || !currentChatId) return;
            
            const message = replyTextArea.value.trim();
            if (!message) return;
            
            console.log(`Відправка відповіді в чат ${currentChatId}: ${message}`);
            
            // Додаємо повідомлення в інтерфейс
            addMessageToChat(message, false, new Date().toISOString());
            replyTextArea.value = '';
            
            // Відправляємо через WebApp API
            const data = {
                action: 'admin_reply',
                chat_id: currentChatId,
                message: message,
                admin_id: tg.initDataUnsafe?.user?.id,
                timestamp: new Date().toISOString()
            };
            
            try {
                tg.sendData(JSON.stringify(data));
                console.log('Відповідь адміна надіслано успішно');
            } catch (error) {
                console.error('Помилка відправки відповіді:', error);
            }
            
            // Оновлюємо список чатів
            setTimeout(loadAllChats, 1000);
        }
        
        // Вставка шаблону відповіді
        function insertTemplate(text) {
            if (replyTextArea) {
                replyTextArea.value = text;
                replyTextArea.focus();
            }
        }
        
        // Блокування користувача
        function blockUser() {
            if (!currentChatId) return;
            
            if (confirm('Ви впевнені, що хочете заблокувати цього користувача?')) {
                const data = {
                    action: 'block_user',
                    chat_id: currentChatId,
                    admin_id: tg.initDataUnsafe?.user?.id
                };
                
                try {
                    tg.sendData(JSON.stringify(data));
                    console.log('Користувача заблоковано');
                } catch (error) {
                    console.error('Помилка блокування:', error);
                }
            }
        }
        
        // Закриття чату
        function closeCurrentChat() {
            if (!currentChatId) return;
            
            if (confirm('Закрити цей чат?')) {
                const data = {
                    action: 'close_chat',
                    chat_id: currentChatId,
                    admin_id: tg.initDataUnsafe?.user?.id
                };
                
                try {
                    tg.sendData(JSON.stringify(data));
                    console.log('Чат закрито');
                    
                    // Очищуємо інтерфейс
                    document.getElementById('noChatSelected').style.display = 'flex';
                    document.getElementById('chatArea').style.display = 'none';
                    currentChatId = null;
                    
                } catch (error) {
                    console.error('Помилка закриття чату:', error);
                }
            }
        }
        
        // Показ індикатора друкування
        function showTypingIndicator(isTyping) {
            if (typingIndicator) {
                if (isTyping) {
                    typingIndicator.classList.add('show');
                } else {
                    typingIndicator.classList.remove('show');
                }
            }
        }
        
        // Форматування часу
        function formatTime(timestamp) {
            if (!timestamp) return '';
            
            const date = new Date(timestamp);
            const now = new Date();
            
            if (date.toDateString() === now.toDateString()) {
                return date.toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit' });
            } else {
                return date.toLocaleDateString('uk-UA', { 
                    day: '2-digit', 
                    month: '2-digit',
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            }
        }
        
        // Прокрутка до низу
        function scrollToBottom() {
            if (chatContainer) {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }
        
        // Події
        if (userFilter) {
            userFilter.addEventListener('change', (e) => {
                selectedUserId = e.target.value;
                renderChatList();
            });
        }
        
        if (searchBox) {
            searchBox.addEventListener('input', renderChatList);
        }
        
        if (sendReplyBtn) {
            sendReplyBtn.addEventListener('click', sendReply);
        }
        
        if (replyTextArea) {
            replyTextArea.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendReply();
                }
            });
        }
        
        // Обробники фільтрів статусу
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                currentFilter = e.target.dataset.filter;
                renderChatList();
            });
        });
        
        // Кнопки шаблонів
        document.querySelectorAll('.template-btn').forEach((btn, index) => {
            btn.addEventListener('click', () => {
                if (responseTemplates[index]) {
                    insertTemplate(responseTemplates[index]);
                }
            });
        });
        
        // Глобальні функції для HTML
        window.blockUser = blockUser;
        window.closeCurrentChat = closeCurrentChat;
        window.insertTemplate = insertTemplate;
        
        // АВТОМАТИЧНЕ ОНОВЛЕННЯ кожні 10 секунд
        updateInterval = setInterval(() => {
            loadAllChats();
            if (currentChatId) {
                loadChatHistory(currentChatId);
            }
        }, 10000);
        
        // Очищуємо інтервал при закритті
        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
        
        // Початкова ініціалізація
        console.log('Ініціалізація адмін-панелі...');
        loadAllChats();
        
        console.log('Адмін-панель ініціалізовано успішно!');
    }
</script>

</body>
</html>
